<!DOCTYPE html>
<html class="direction--ltr"lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>ARM64 Reversing and Exploitation Part 2 - Use After Free | Prateekg147</title>
<meta name="generator" content="Jekyll v4.2.2" />
<meta property="og:title" content="ARM64 Reversing and Exploitation Part 2 - Use After Free" />
<meta name="author" content="Prateek Gianchandani" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="In this blog post, we will be exploiting a Use-after-free vulnerability in the vuln binary. The binaries for this and the next article can be found here. This UaF challenge is based on the one used by Protostar" />
<meta property="og:description" content="In this blog post, we will be exploiting a Use-after-free vulnerability in the vuln binary. The binaries for this and the next article can be found here. This UaF challenge is based on the one used by Protostar" />
<meta property="og:site_name" content="Prateekg147" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-09-06T09:30:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="ARM64 Reversing and Exploitation Part 2 - Use After Free" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Prateek Gianchandani"},"dateModified":"2020-09-06T09:30:00+00:00","datePublished":"2020-09-06T09:30:00+00:00","description":"In this blog post, we will be exploiting a Use-after-free vulnerability in the vuln binary. The binaries for this and the next article can be found here. This UaF challenge is based on the one used by Protostar","headline":"ARM64 Reversing and Exploitation Part 2 - Use After Free","mainEntityOfPage":{"@type":"WebPage","@id":"/2020/09/06/arm64-reversing-and-exploitation-part-2-use-after-free.html"},"url":"/2020/09/06/arm64-reversing-and-exploitation-part-2-use-after-free.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css">
  <link rel="icon" type="image/png" href="/assets/favicon.png" />
  <link rel="stylesheet" href="/assets/css/magnific-popup.css"><link type="application/atom+xml" rel="alternate" href="/feed.xml" title="Prateekg147" /><script src="https://code.jquery.com/jquery-3.2.0.min.js"></script> 
  <script src="/assets/js/jquery.magnific-popup.js"></script>
</head>
<body><div class="site-header">
  <div class="wrapper">
    <a class="site-title" rel="author" href="/">Blogs<b class="command_prompt"></b></a>
    <a class="site-title" rel="author" href="/about">About<b class="command_prompt"></b><b class="blinking_cursor">_</b></a>
    <span class="social_links">
        
        
        <a class="color-cyan-hover" href="https://twitter.com/prateekg147"><i class="fab fa-twitter-square"></i></a>
        
        
        
        <a class="color-indigo-hover" href="https://www.linkedin.com/in/prateekgianchandani/"><i class="fab fa-linkedin"></i></a>
        
        
        
        <a class="color-yellow-hover" href="https://github.com/prateek147"><i class="fab fa-github-square"></i></a>
        
        
    </span>
  </div>
</div>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        
  <div class="author-box">


<img src="
    https://pbs.twimg.com/profile_images/1244561732170899457/SRr3p2iV_400x400.jpg
" class="author-avatar" alt="Avatar" />
<div class="description">I am Prateek Gianchandani. Currently i am working as a Security Researcher in UAE.  I have interests in Exploit Development, Mobile and Browser Security....<a href="/about"> Continue</a>
</div>

</div>


<div class="post">
  <h1 class="post-title">ARM64 Reversing and Exploitation Part 2 - Use After Free</h1>
  
  <div class="post-tags">
      
      <a class="tag" href="/tag/security/">security</a>
      
      <a class="tag" href="/tag/ios/">ios</a>
      
  </div>
  
  <div class="post-date">
    Published on 06 Sep 2020
    
  </div>
  
  <p>In this blog post, we will be exploiting a Use-after-free vulnerability in the <em>vuln</em> binary. The binaries for this and the next article can be found <a href="https://drive.google.com/file/d/1f3PDEz-Fh9I3rSDhpMGW5ZrCU9g0BjKL/view?usp=sharing">here</a>. This UaF challenge is based on the one used by <a href="https://exploit.education/protostar/heap-two/">Protostar</a></p>

<p><a href="https://owasp.org/www-community/vulnerabilities/Using_freed_memory">Use-after-free</a> vulnerabilities occurs on the use of heap allocated memory after it has been freed. This can lead to several unexpected behaviours, from a crash to code execution.</p>

<p>Anyways, let’s get started. Copy the vuln binary to your iOS or Corellium device.</p>

<p>Run the binary <strong>vuln</strong>. You get a message that says “Better luck next time”</p>

<p><img src="/images/posts/arm/1.png" alt="1" /></p>

<p>Let’s open the binary in Hopper to see what’s going on. Let’s have a look at the main function.</p>

<p>Just like the previous example on Heap Overflow, our objective here is to jump the <strong>useafterfree</strong> function. For that, we need to pass in the argument <strong>uaf</strong></p>

<!--more-->

<p><img src="/images/posts/arm/6.png" alt="1" /></p>

<p>The function then jumps execution to the function <strong>useafterfree</strong></p>

<p><strong>./vuln uaf</strong></p>

<p><img src="/images/posts/arm/7.png" alt="1" /></p>

<p>The output shows the address of the <strong>user</strong> and the <strong>customerChat</strong> object. We see several commands here, however on reversing the function, we find there is another hidden command <strong>reset</strong> that basically frees the <strong>user</strong> object.</p>

<p><img src="/images/posts/arm/8.png" alt="1" />
<img src="/images/posts/arm/8a.png" alt="1" /></p>

<p>This can be confirmed by looking at the code itself</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt">void</span> <span class="nf">useafterfree</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">input</span><span class="p">){</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Use after free challenge. Try to log in without entering the password. Available commands are:</span><span class="se">\n</span><span class="s">a) username XYZ</span><span class="se">\n</span><span class="s">b) login</span><span class="se">\n</span><span class="s">c) customerChat XYZ.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="kt">char</span> <span class="n">line</span><span class="p">[</span><span class="mh">0x400</span><span class="p">];</span>
    <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"{user = %p, customerChat = %p }</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">customerChat</span><span class="p">);</span>
        
        <span class="k">if</span><span class="p">(</span><span class="n">fgets</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">line</span><span class="p">),</span> <span class="n">stdin</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
        
        <span class="k">if</span><span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s">"username "</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">currentUser</span><span class="p">));</span>
            <span class="n">memset</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">currentUser</span><span class="p">));</span>
            <span class="k">if</span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mh">0x100</span><span class="p">)</span> <span class="p">{</span>
            	<span class="n">printf</span><span class="p">(</span><span class="s">"Setting username</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                <span class="n">strcpy</span><span class="p">(</span><span class="n">user</span><span class="o">-&gt;</span><span class="n">username</span><span class="p">,</span> <span class="n">line</span> <span class="o">+</span> <span class="mi">9</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span><span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s">"reset"</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        	<span class="n">printf</span><span class="p">(</span><span class="s">"Freeing user object</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
            <span class="n">free</span><span class="p">(</span><span class="n">user</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span><span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s">"customerChat "</span><span class="p">,</span> <span class="mi">13</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">customerChat</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="mi">12</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span><span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s">"currentUser"</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"Current user is %s"</span><span class="p">,</span> <span class="n">user</span><span class="o">-&gt;</span><span class="n">username</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span><span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s">"login"</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">user</span><span class="o">-&gt;</span><span class="n">password</span><span class="p">,</span> <span class="s">"BBB"</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">"You have successfully logged in with password %s!</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">user</span><span class="o">-&gt;</span><span class="n">password</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">"Please enter your password</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">"current password is %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">user</span><span class="o">-&gt;</span><span class="n">password</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>We see that the user struct object has an attribute <strong>password</strong> . This is being checked later on. If the password has three B’s, the user gets logged in.</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"> <span class="k">if</span><span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">user</span><span class="o">-&gt;</span><span class="n">password</span><span class="p">,</span> <span class="s">"BBB"</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">"You have successfully logged in with password %s!</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">user</span><span class="o">-&gt;</span><span class="n">password</span><span class="p">);</span>
            <span class="p">}</span> </code></pre></figure>

<p>This is an example of a <strong>UaF</strong> since the user object can be freed by using the <strong>reset</strong> command and then calling <strong>if(user-&gt;password)</strong> will basically trigger the UaF.</p>

<p>We can also calculate the size of the user object. The user object is a object of struct <strong>currentUser</strong> as can be seen in the following line</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">user</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">currentUser</span><span class="p">));</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">struct</span> <span class="n">currentUser</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">username</span><span class="p">[</span><span class="mh">0x100</span><span class="p">];</span>
    <span class="kt">char</span> <span class="n">password</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
<span class="p">};</span></code></pre></figure>

<p>The size of the user object is 256 + 4 = 260 bytes.</p>

<p>If we can free the user object using <strong>reset</strong> and then overwrite it with the value <strong>BBBB</strong> such that we are able to overwrite the <strong>password</strong> property, we might be able to execute a <strong>Use-after-free</strong> condition and successfully log in.</p>

<p>Since our objective is to login, so let’s try that by first entering the username command,</p>

<p>$<strong>username admin</strong></p>

<p>$<strong>login</strong></p>

<p><img src="/images/posts/arm/9.png" alt="1" /></p>

<p>Now let’s enter the <strong>reset</strong> command, this will free the buffer. Now let’s enter the <strong>customerChat</strong> command followed by the chat and send 260 B’s (so the size of cutomerChat object is the same as than of user object), we keep entering the size of the chat around the same size of the user so that it can take over the memory address of the freed user object.</p>

<p><img src="/images/posts/arm/10.png" alt="1" /></p>

<p>After some tries, we see that the customerChat address is overlapping the user address, in this case we were able to overwrite the <strong>password</strong> property of the freed user object with all B’s. And hence entering the <strong>login</strong> command again gives us a success.</p>

<p>Command in order</p>

<ol>
  <li>username admin</li>
  <li>login</li>
  <li>reset</li>
  <li>customerChat BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB</li>
  <li>login</li>
</ol>


</div>





<div class="related">
  <h2>related posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/2020/09/06/arm64-reversing-and-exploitation-part-3-a-simple-rop-chain.html">
            ARM64 Reversing and Exploitation Part 3 - A Simple ROP Chain
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2020/09/05/arm64-reversing-and-exploitation-part-1-arm-instruction-set-heap-overflow.html">
            ARM64 Reversing and Exploitation Part 1 - ARM Instruction Set + Simple Heap Overflow
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2020/06/01/from-zero-to-tfp0-part-2-a-walkthrough-of-the-voucher-swap-exploit.html">
            From zero to tfp0 - Part 2: A Walkthrough of the voucher_swap exploit
          </a>
        </h3>
      </li>
    
  </ul>
</div>




  
  <h2>all tags</h2>
  <div class="tag-cloud"><a href="/tag/android/" class="set-1">android</a> <a href="/tag/authentication/" class="set-1">authentication</a> <a href="/tag/backtrack/" class="set-1">backtrack</a> <a href="/tag/burpsuite/" class="set-1">burpsuite</a> <a href="/tag/defcon/" class="set-1">defcon</a> <a href="/tag/dns/" class="set-1">dns</a> <a href="/tag/honeypots/" class="set-1">honeypots</a> <a href="/tag/ios/" class="set-1">ios</a> <a href="/tag/maintaining-access/" class="set-1">maintaining-access</a> <a href="/tag/meshnet/" class="set-1">meshnet</a> <a href="/tag/metasploit/" class="set-1">metasploit</a> <a href="/tag/networking/" class="set-1">networking</a> <a href="/tag/privacy/" class="set-1">privacy</a> <a href="/tag/security/" class="set-5">security</a> <a href="/tag/timing-analysis-attacks/" class="set-1">timing-analysis-attacks</a> <a href="/tag/w3af/" class="set-1">w3af</a> <a href="/tag/web-application-security/" class="set-1">web-application-security</a></div>
  




<script>
  let i = 0;
  const text = '';
  const speed = parseInt('50');
  
  function typeWriter() {
    if (i < text.length) {
      document.getElementById('animated-post-description').innerHTML += text.charAt(i);
      i++;
      setTimeout(typeWriter, speed);
    }
  }

  document.getElementById('animated-post-description').style.display = 'initial';
  typeWriter();

  // Image modal
  var $imgs = [];
  $('img').each(function(idx) {
    var obj = {
      src: $(this).attr('src')
    }
    $imgs.push(obj);
    var elem = $(this);
    $(this).click(function() {
      $('.modal').magnificPopup('open', idx);
    });
  });

  $('.modal').magnificPopup({
    items: $imgs,
    type: 'image',
    closeOnContentClick: true,
    mainClass: 'mfp-img-mobile',
    image: {
      verticalFit: true
    }
    
  });
</script>

      </div>
    </main><footer class="site-footer">
  <div class="wrapper">
    <div class="credits"><a href="https://github.com/bitbrain/jekyll-dash">dash</a> theme for Jekyll by <a href="https://github.com/bitbrain">bitbrain</a> made with <i class="fas fa-heart"></i><div class="toggleWrapper">
    <input type="checkbox" class="dn" id="theme-toggle" onclick="modeSwitcher()" checked />
    <label for="theme-toggle" class="toggle">
    <span class="toggle__handler">
      <span class="crater crater--1"></span>
      <span class="crater crater--2"></span>
      <span class="crater crater--3"></span>
    </span>
        <span class="star star--1"></span>
        <span class="star star--2"></span>
        <span class="star star--3"></span>
        <span class="star star--4"></span>
        <span class="star star--5"></span>
        <span class="star star--6"></span>
    </label>
</div>
<script type="text/javascript">
const theme = localStorage.getItem('theme');

if (theme === "light") {
    document.documentElement.setAttribute('data-theme', 'light');
} else {
    document.documentElement.setAttribute('data-theme', 'dark');
}
const userPrefers = getComputedStyle(document.documentElement).getPropertyValue('content');

function activateDarkTheme() {
    document.getElementById('theme-toggle').checked = true;
    document.documentElement.setAttribute('data-theme', 'dark');
    document.documentElement.classList.add('theme--dark');
    document.documentElement.classList.remove('theme--light');
	document.getElementById("theme-toggle").className = 'light';
	window.localStorage.setItem('theme', 'dark');
}

function activateLightTheme() {
    document.getElementById('theme-toggle').checked = false;
    document.documentElement.setAttribute('data-theme', 'light');
    document.documentElement.classList.add('theme--light');
    document.documentElement.classList.remove('theme--dark');
	document.getElementById("theme-toggle").className = 'dark';
	window.localStorage.setItem('theme', 'light');
}

if (theme === "dark") {
    activateDarkTheme();
} else if (theme === "light") {
    activateLightTheme();
} else if  (userPrefers === "light") {
    activateDarkTheme();
} else {
    activateDarkTheme();
}

function modeSwitcher() {
	let currentMode = document.documentElement.getAttribute('data-theme');
	if (currentMode === "dark") {
	    activateLightTheme();
	} else {
	    activateDarkTheme();
	}
}
</script></div>
  </div>
</footer>


<script>
      window.FontAwesomeConfig = {
        searchPseudoElements: true
      }
    </script>
  </body>

</html>
